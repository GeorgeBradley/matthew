<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Project Details â€“ Professional Showcase</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="shareable.css" media="all">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom CSS for gradients, animations, and pseudo-elements */
    :root {
      --primary: #005f73;
      --header-gradient: linear-gradient(135deg, #005f73, #0a9396);
      --accent: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      --lightbox-bg: rgba(0, 0, 0, 0.8);
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { to { transform: rotate(360deg); } }
    .detail-header::after, 
    .testimonial-section h2::after, 
    .youtube-section h2::after, 
    .gallery-section h2::after, 
    .related-projects h2::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: #005f73;
      border-radius: 2px;
    }
    .detail-header::after { width: 80px; height: 4px; background: var(--accent); }
    .close-btn::before,
    .close-btn::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 2px;
      background: #fff;
    }
    .close-btn::before { transform: rotate(45deg); }
    .close-btn::after { transform: rotate(-45deg); }
  </style>
</head>
<body class="m-0 font-['Poppins'] bg-gray-100 text-gray-800 leading-relaxed">
  <nav class="main-navigation-nav">
    <a href="index.html#home">
      <img src="Header.png" alt="Logo" class="main-navigation-logo">
    </a>
    <div class="main-navigation-nav-links">
      <a href="index.html#home">Home</a>
      <a href="index.html#projects-container">Projects</a>
      <a href="index.html#contact">Contact</a>
      <a href="portfolio-cv.html" class="cta-button">CV / Portfolio</a>
    </div>
    <button class="main-navigation-hamburger">
      <span></span>
      <span></span>
      <span></span>
    </button>
  </nav>

  <br><br><br><br>

  <!-- Project Detail Container -->
  <main id="project-detail-container" class="p-2"></main>

  <div class="back-to-top fixed bottom-5 left-1/2 -translate-x-1/2 bg-[#005f73] text-white w-12 h-12 rounded-full flex items-center justify-center cursor-pointer opacity-0 transition-opacity duration-300 z-[100] hover:opacity-100 hover:scale-110" title="Back to Top">
    <i class="fas fa-chevron-up text-xl"></i>
  </div>

  <script>
    // Global Variables
    const PROJECTS_URL = 'feature-project.json';
    const CATEGORIES_URL = 'feature-project-category.json';
    const detailsContainer = document.getElementById('project-detail-container');
    const urlParams = new URLSearchParams(window.location.search);
    const projectParam = urlParams.get('id');
    const categoryParam = urlParams.get('cat');
    
    let allProjects = [];
    let allCategories = [];
    let galleryImagesGlobal = [];
    const imagesPerPage = 5;
    let currentGalleryPage = 1;
    let currentImageIndex = 0;
    let lightboxInitialized = false;
    
    const stopwords = new Set(['the', 'and', 'is', 'in', 'at', 'of', 'a', 'an', 'to', 'for', 'with', 'on', 'by', 'this', 'that', 'it']);

    function tokenize(text) {
      return text.toLowerCase()
                 .replace(/[^\w\s]/g, '')
                 .split(/\s+/)
                 .filter(word => word && !stopwords.has(word));
    }

    function computeTFIDFVectors(projects) {
      const N = projects.length;
      const tfVectors = {};
      const df = {};
      
      projects.forEach(p => {
        if (p["feature-project-long-description"]) {
          const tokens = tokenize(p["feature-project-long-description"]);
          tfVectors[p.id] = { tf: {}, total: tokens.length };
          tokens.forEach(token => {
            tfVectors[p.id].tf[token] = (tfVectors[p.id].tf[token] || 0) + 1;
          });
          new Set(tokens).forEach(token => {
            df[token] = (df[token] || 0) + 1;
          });
        }
      });
      
      const tfidfVectors = {};
      Object.keys(tfVectors).forEach(docId => {
        const { tf, total } = tfVectors[docId];
        const vector = {};
        Object.keys(tf).forEach(token => {
          const termFreq = tf[token] / total;
          const inverseDF = Math.log(N / (df[token] + 1));
          vector[token] = termFreq * inverseDF;
        });
        const magnitude = Math.sqrt(Object.values(vector).reduce((sum, w) => sum + w * w, 0));
        tfidfVectors[docId] = { vector, magnitude };
      });
      
      return tfidfVectors;
    }
    
    function cosineSimilarity(vecA, magA, vecB, magB) {
      let dot = 0;
      for (let token in vecA) {
        if (vecB[token]) dot += vecA[token] * vecB[token];
      }
      return (magA && magB) ? dot / (magA * magB) : 0;
    }
    
    function getProjectsData() {
      const key = "projectsData";
      return new Promise((resolve, reject) => {
        let data = localStorage.getItem(key);
        if (data) {
          resolve(JSON.parse(data));
        } else {
          fetch(PROJECTS_URL)
            .then(response => {
              if (!response.ok) reject(new Error('Network response was not ok'));
              return response.json();
            })
            .then(data => { localStorage.setItem(key, JSON.stringify(data)); resolve(data); })
            .catch(reject);
        }
      });
    }
    
    function getCategoriesData() {
      const key = "categoriesData";
      return new Promise((resolve, reject) => {
        let data = localStorage.getItem(key);
        if (data) {
          resolve(JSON.parse(data));
        } else {
          fetch(CATEGORIES_URL)
            .then(response => {
              if (!response.ok) reject(new Error('Network response was not ok'));
              return response.json();
            })
            .then(data => { localStorage.setItem(key, JSON.stringify(data)); resolve(data); })
            .catch(reject);
        }
      });
    }
    
    async function fetchData() {
      try {
        allProjects = await getProjectsData();
        allCategories = await getCategoriesData();
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }
    
    function getRelatedProjects(currentProjectId, allProjects) {
      const currentProject = allProjects.find(p => p.id === currentProjectId);
      if (!currentProject) return [];

      const clientFreq = {};
      const categoryFreq = {};
      const skillFreq = {};

      allProjects.forEach(p => {
        const client = p["feature-project-client"];
        if (client) clientFreq[client] = (clientFreq[client] || 0) + 1;
        const category = p["project-feature-main-category-id"];
        if (category) categoryFreq[category] = (categoryFreq[category] || 0) + 1;
        (p["feature-project-skills"] || []).forEach(s => {
          skillFreq[s] = (skillFreq[s] || 0) + 1;
        });
      });

      const tfidfVectors = computeTFIDFVectors(allProjects);
      const currentTFIDF = tfidfVectors[currentProject.id];

      const scoredProjects = allProjects
        .filter(p => p.id !== currentProjectId)
        .map(project => {
          let score = 0;
          if (project["feature-project-client"] === currentProject["feature-project-client"]) {
            score += 3 / Math.sqrt(clientFreq[project["feature-project-client"]] || 1);
          }
          if (project["project-feature-main-category-id"] === currentProject["project-feature-main-category-id"]) {
            score += 2 / Math.sqrt(categoryFreq[project["project-feature-main-category-id"]] || 1);
          }
          const currentSkills = currentProject["feature-project-skills"] || [];
          const projectSkills = project["feature-project-skills"] || [];
          const sharedSkills = projectSkills.filter(s => currentSkills.includes(s));
          sharedSkills.forEach(skill => {
            score += 1 / Math.sqrt(skillFreq[skill] || 1);
          });
          const currentYear = currentProject["feature-project-start-year"] || "";
          const projectYear = project["feature-project-start-year"] || "";
          if (currentYear && projectYear && currentYear === projectYear) score += 0.5;
          let tfidfSim = 0;
          if (currentTFIDF && tfidfVectors[project.id]) {
            tfidfSim = cosineSimilarity(currentTFIDF.vector, currentTFIDF.magnitude, tfidfVectors[project.id].vector, tfidfVectors[project.id].magnitude);
          }
          score += tfidfSim * 2.0;

          return { project, score };
        })
        .filter(item => item.score > 0)
        .sort((a, b) => b.score - a.score)
        .slice(0, 3)
        .map(item => item.project);

      return scoredProjects;
    }
    
    async function initPage() {
      await fetchData();
      if (categoryParam) {
        const category = allCategories.find(c => c.id === Number(categoryParam));
        if (category) {
          const filteredProjects = allProjects.filter(
            p => p["project-feature-main-category-id"] === Number(categoryParam) &&
                 p["feature-project-type"] === "un-highlighted"
          );
          renderCategoryDetails(category, filteredProjects);
          initLightbox();
        } else showDetailError();
      } else if (projectParam) {
        const project = allProjects.find(p => p.id === Number(projectParam));
        if (project) {
          renderProjectDetails(project, allProjects);
          initLightbox();
        } else showDetailError();
      } else showDetailError();
    }
    
    function getNavigationProjects(project, allProjects) {
      const highlightedProjects = allProjects
        .filter(p => p["feature-project-type"] === "highlighted")
        .sort((a, b) => a["feature-project-order"] - b["feature-project-order"]);
      const currentIndex = highlightedProjects.findIndex(p => p.id === project.id);
      if (currentIndex === -1) return { prevProject: null, nextProject: null };
      const prevProject = currentIndex > 0 ? highlightedProjects[currentIndex - 1] : null;
      const nextProject = currentIndex < highlightedProjects.length - 1 ? highlightedProjects[currentIndex + 1] : null;
      return { prevProject, nextProject };
    }
    
    function renderProjectDetails(project, projects) {
      const { prevProject, nextProject } = getNavigationProjects(project, projects);
      const testimonials = project["feature-project-testimonial"] && Array.isArray(project["feature-project-testimonial"]) ? 
                           project["feature-project-testimonial"].filter(t => t["testimonial-quote"] && t["testimonial-quote"] !== null) : [];
      const hasTestimonials = testimonials.length > 0;
      const testimonialCount = testimonials.length;
      const testimonialSectionTitle = testimonialCount === 1 ? 'Testimonial' : 'Testimonials';

      const youtubeVideos = project["feature-project-youtube-link"] && Array.isArray(project["feature-project-youtube-link"]) && 
                            project["feature-project-youtube-link"].length > 0 ? 
                            project["feature-project-youtube-link"].filter(video => video.url && video.url !== null && video.url !== '') : [];
      const hasYouTubeVideos = youtubeVideos.length > 0;
      const videoCount = youtubeVideos.length;
      const youtubeSectionTitle = videoCount === 1 ? 'Video' : 'Videos';

      const relatedProjects = getRelatedProjects(project.id, projects);

      detailsContainer.innerHTML = `
        <a href="index.html" class="back-link inline-block bg-[#005f73] text-white py-3 px-6 rounded-lg font-semibold w-fit transition-colors duration-300 hover:bg-[#004c59] mx-auto my-4">
          <i class="fas fa-arrow-left"></i> Back to Projects
        </a>
        <article class="project-detail max-w-[1100px] bg-white rounded-xl overflow-hidden shadow-lg animate-[fadeIn_0.5s_ease-out] mx-auto mb-8">
          <header class="detail-header bg-[var(--header-gradient)] text-center text-white flex flex-col pb-4 relative">
            <h1 class="project-title my-4 text-4xl font-bold tracking-wide shadow-[1px_1px_2px_rgba(0,0,0,0.3)]">${project["feature-project-name"]}</h1>
            ${project["feature-project-start-year"] ? `
              <div class="project-meta text-base opacity-90 flex justify-center gap-4 py-1">
                <span>${project["feature-project-start-year"]}${project["feature-project-end-year"] ? ` - ${project["feature-project-end-year"]}` : ''}</span>
              </div>
            ` : ''}
          </header>
          <img src="${project["feature-project-thumbnail"]}" alt="${project["feature-project-name"]}" class="detail-image max-w-full block w-[600px] mx-auto my-4 h-[250px] object-contain transition-transform duration-400 hover:scale-103">
          <section class="detail-content p-8">
            <p class="project-description max-w-[900px] mx-auto mb-8 text-lg text-justify text-gray-600">${project["feature-project-long-description"]}</p>
            ${hasTestimonials ? `
              <div class="testimonial-section my-8 px-8 relative">
                <h2 class="text-center text-3xl mb-6 relative pb-2">${testimonialSectionTitle}</h2>
                <div class="testimonial-container max-w-[900px] mx-auto overflow-hidden">
                  <div class="testimonial-slider flex transition-transform duration-500 w-full">
                    ${testimonials.map(testimonial => `
                      <div class="testimonial-item flex-shrink-0 w-full bg-white border border-gray-200 rounded-lg p-8 text-center shadow-md">
                        <p class="testimonial-quote text-lg italic text-gray-600 mb-4">"${testimonial["testimonial-quote"]}"</p>
                        <p class="testimonial-author font-semibold text-[#005f73] mb-2">${testimonial["testimonial-name"]}</p>
                        <p class="testimonial-role text-sm text-gray-800 opacity-80">${testimonial["testimonial-role"]}${testimonial["testimonial-client-name"] ? `, ${testimonial["testimonial-client-name"]}` : ''}</p>
                      </div>
                    `).join('')}
                  </div>
                </div>
                ${testimonialCount > 1 ? `
                  <div class="testimonial-nav flex justify-center gap-4 mt-4">
                    <button class="testimonial-nav-btn prev bg-[#005f73] text-white border-none rounded-full w-10 h-10 flex items-center justify-center cursor-pointer transition-all duration-300 hover:bg-[#004c59] hover:scale-110 disabled:bg-gray-300 disabled:cursor-not-allowed" aria-label="Previous testimonial">
                      <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="testimonial-nav-btn next bg-[#005f73] text-white border-none rounded-full w-10 h-10 flex items-center justify-center cursor-pointer transition-all duration-300 hover:bg-[#004c59] hover:scale-110 disabled:bg-gray-300 disabled:cursor-not-allowed" aria-label="Next testimonial">
                      <i class="fas fa-chevron-right"></i>
                    </button>
                  </div>
                  <div class="testimonial-dots flex justify-center gap-2 mt-4">
                    ${testimonials.map((_, index) => `
                      <span class="testimonial-dot w-3 h-3 bg-gray-300 rounded-full cursor-pointer transition-colors duration-300 ${index === 0 ? 'active bg-[#005f73]' : ''}" data-index="${index}"></span>
                    `).join('')}
                  </div>
                ` : ''}
              </div>
            ` : ''}
            ${hasYouTubeVideos ? `
              <div class="youtube-section my-8 relative">
                <h2 class="text-center text-3xl mb-6 relative pb-2">${youtubeSectionTitle}</h2>
                <div class="youtube-container max-w-[900px] mx-auto overflow-hidden">
                  <div class="youtube-slider flex transition-transform duration-500 w-full">
                    ${youtubeVideos
                      .sort((a, b) => a.order - b.order)
                      .map(video => `
                        <div class="youtube-item flex-shrink-0 w-full bg-white border border-gray-200 rounded-lg p-4 text-center shadow-md">
                          <iframe src="${video.url}" title="${video.title}" allowfullscreen loading="lazy" class="w-full aspect-video border-none mb-4 mx-auto"></iframe>
                          <p class="youtube-title text-lg font-semibold text-[#005f73] mb-2">${video.title}</p>
                          <p class="youtube-description text-base text-gray-600">${video.description}</p>
                        </div>
                      `).join('')}
                  </div>
                </div>
                ${videoCount > 1 ? `
                  <div class="youtube-nav flex justify-center gap-4 mt-4 mb-5">
                    <button class="youtube-nav-btn prev bg-[#005f73] text-white border-none rounded-full w-10 h-10 flex items-center justify-center cursor-pointer transition-all duration-300 hover:bg-[#004c59] hover:scale-110 disabled:bg-gray-300 disabled:cursor-not-allowed" aria-label="Previous video">
                      <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="youtube-nav-btn next bg-[#005f73] text-white border-none rounded-full w-10 h-10 flex items-center justify-center cursor-pointer transition-all duration-300 hover:bg-[#004c59] hover:scale-110 disabled:bg-gray-300 disabled:cursor-not-allowed" aria-label="Next video">
                      <i class="fas fa-chevron-right"></i>
                    </button>
                  </div>
                  <div class="youtube-dots flex justify-center gap-2 mt-4">
                    ${youtubeVideos.map((_, index) => `
                      <span class="youtube-dot w-3 h-3 bg-gray-300 rounded-full cursor-pointer transition-colors duration-300 ${index === 0 ? 'active bg-[#005f73]' : ''}" data-index="${index}"></span>
                    `).join('')}
                  </div>
                ` : ''}
              </div>
            ` : ''}
            ${project["feature-project-gallery"] && project["feature-project-gallery"].length ? `
              <div id="gallery-section-container"></div>
            ` : ''}
            <div class="detail-grid grid grid-cols-[repeat(auto-fit,minmax(280px,1fr))] gap-6 my-8 px-8">
              ${project["feature-project-company-name"] ? `
                <div class="detail-item bg-gray-100 p-6 border border-gray-200 rounded-lg text-center transition-all duration-300 hover:-translate-y-1 hover:shadow-lg">
                  <h3 class="text-sm uppercase tracking-wider text-[#005f73] mb-2">Company</h3>
                  <p>${project["feature-project-company-name"]}</p>
                </div>
              ` : ''}
              ${project["feature-project-client"] ? `
                <div class="detail-item bg-gray-100 p-6 border border-gray-200 rounded-lg text-center transition-all duration-300 hover:-translate-y-1 hover:shadow-lg">
                  <h3 class="text-sm uppercase tracking-wider text-[#005f73] mb-2">Client</h3>
                  <p>${project["feature-project-client"]}</p>
                </div>
              ` : ''}
              ${project["feature-project-skills"] && project["feature-project-skills"].length ? `
                <div class="detail-item bg-gray-100 p-6 border border-gray-200 rounded-lg text-center transition-all duration-300 hover:-translate-y-1 hover:shadow-lg">
                  <h3 class="text-sm uppercase tracking-wider text-[#005f73] mb-2">Skills Used</h3>
                  <div class="skill-list flex flex-wrap justify-center gap-2 mt-3">
                    ${project["feature-project-skills"].map(skill => `<span class="skill-tag bg-[#005f73] text-white py-1 px-3 rounded-full text-sm font-semibold">${skill}</span>`).join('')}
                  </div>
                </div>
              ` : ''}
            </div>
          </section>
          ${prevProject || nextProject ? `
            <nav class="other-project-nav-container flex justify-between bg-[var(--accent)] border-t border-gray-200 flex-wrap p-4 gap-4">
              ${prevProject ? `
                <a href="details.html?id=${prevProject.id}" class="other-project-nav-button flex-1 bg-white border border-gray-200 rounded-md flex items-center justify-center font-semibold transition-all duration-300 text-gray-800 flex-col p-2 text-center hover:bg-gray-100 hover:-translate-y-1 hover:border-[#005f73]" title="Previous project: ${prevProject["feature-project-name"]}">
                  <i class="fas fa-arrow-left w-full text-center my-1 p-2"></i>
                  <span>${prevProject["feature-project-name"]}</span>
                </a>
              ` : '<div class="other-project-nav-spacer"></div>'}
              ${nextProject ? `
                <a href="details.html?id=${nextProject.id}" class="other-project-nav-button flex-1 bg-white border border-gray-200 rounded-md flex items-center justify-center font-semibold transition-all duration-300 text-gray-800 flex-col p-2 text-center hover:bg-gray-100 hover:-translate-y-1 hover:border-[#005f73]" title="Next project: ${nextProject["feature-project-name"]}">
                  <span>${nextProject["feature-project-name"]}</span>
                  <i class="fas fa-arrow-right w-full text-center my-1 p-2"></i>
                </a>
              ` : '<div class="other-project-nav-spacer"></div>'}
            </nav>
          ` : ''}
          ${relatedProjects.length > 0 ? `
            <section class="related-projects my-8 px-8 relative">
              <h2 class="text-center text-3xl mb-6 relative pb-2">Related Projects</h2>
              <div class="project-grid grid grid-cols-[repeat(auto-fit,minmax(280px,1fr))] gap-6 max-w-[1100px] mx-auto">
                ${relatedProjects.map(p => `
                  <a href="details.html?id=${p.id}" class="related-project bg-white border border-gray-200 rounded-lg overflow-hidden transition-all duration-300 text-center hover:-translate-y-1 hover:shadow-xl">
                    <img src="${p["feature-project-thumbnail"]}" alt="${p["feature-project-name"]}" class="related-thumbnail w-full aspect-video object-contain block" loading="lazy">
                    <h3 class="p-4 text-lg text-gray-800">${p["feature-project-name"]}</h3>
                  </a>
                `).join('')}
              </div>
            </section>
          ` : ''}
          ${getLightboxMarkup()}
        </article>
      `;

      if (project["feature-project-gallery"] && project["feature-project-gallery"].length) {
        galleryImagesGlobal = project["feature-project-gallery"].sort((a, b) => a.order - b.order);
        renderGallerySection(galleryImagesGlobal);
      }
      
      if (hasTestimonials && testimonialCount > 1) initTestimonialSlider(testimonialCount);
      if (hasYouTubeVideos && videoCount > 1) initYouTubeSlider(videoCount);
    }
    
    function renderGallerySection(galleryImages) {
      const container = document.getElementById('gallery-section-container');
      container.innerHTML = `
        <div class="gallery-section my-8 px-8">
          <h2 class="text-center text-3xl mb-6 relative pb-2">Gallery</h2>
          <div id="galleryGrid" class="gallery-grid grid grid-cols-[repeat(auto-fit,minmax(280px,1fr))] gap-6 max-w-[1100px] mx-auto"></div>
          <div id="paginationControls" class="pagination-controls hidden justify-center items-center gap-4 mt-4 md:flex"></div>
        </div>
      `;
      currentGalleryPage = 1;
      renderGalleryPage();
    }
    
    function renderGalleryPage() {
      const galleryGrid = document.getElementById('galleryGrid');
      const paginationControls = document.getElementById('paginationControls');
      let startIndex, endIndex;
      if (window.innerWidth >= 1024) {
        startIndex = 0;
        endIndex = galleryImagesGlobal.length;
        paginationControls.innerHTML = '';
      } else {
        const totalImages = galleryImagesGlobal.length;
        const totalPages = Math.ceil(totalImages / imagesPerPage);
        startIndex = (currentGalleryPage - 1) * imagesPerPage;
        endIndex = Math.min(startIndex + imagesPerPage, totalImages);
        if (totalPages > 1) {
          let controlsHTML = '';
          if (currentGalleryPage > 1) {
            controlsHTML += `<button class="pagination-button bg-[#005f73] text-white border-none py-2 px-4 rounded cursor-pointer font-semibold transition-colors duration-300 hover:bg-[#004c59]" id="prevPage">Previous</button>`;
          }
          controlsHTML += `<span class="pagination-info text-sm text-gray-600">Page ${currentGalleryPage} of ${totalPages}</span>`;
          if (currentGalleryPage < totalPages) {
            controlsHTML += `<button class="pagination-button bg-[#005f73] text-white border-none py-2 px-4 rounded cursor-pointer font-semibold transition-colors duration-300 hover:bg-[#004c59]" id="nextPage">Next</button>`;
          }
          paginationControls.innerHTML = controlsHTML;
          const prevBtn = document.getElementById('prevPage');
          if (prevBtn) {
            prevBtn.addEventListener('click', () => {
              currentGalleryPage--;
              renderGalleryPage();
              scrollToGalleryTitle();
            });
          }
          const nextBtn = document.getElementById('nextPage');
          if (nextBtn) {
            nextBtn.addEventListener('click', () => {
              currentGalleryPage++;
              renderGalleryPage();
              scrollToGalleryTitle();
            });
          }
        } else paginationControls.innerHTML = '';
      }
      galleryGrid.innerHTML = galleryImagesGlobal
        .slice(startIndex, endIndex)
        .map((image, i) => {
          const globalIndex = startIndex + i;
          return `
            <div class="gallery-item relative border border-gray-200 rounded-lg overflow-hidden cursor-pointer bg-white transition-all duration-300 hover:-translate-y-1 hover:shadow-xl">
              <img src="${image.image}" alt="${image['alt-text']}" class="gallery-thumbnail w-full aspect-video object-contain block" data-index="${globalIndex}" loading="lazy">
              <div class="gallery-overlay absolute bottom-0 left-0 right-0 bg-[#005f73]/85 text-white p-2 text-center text-sm opacity-0 transition-opacity duration-300 hover:opacity-100">${image.description}</div>
            </div>
          `;
        }).join('');
      attachGalleryThumbnails();
    }
    
    function scrollToGalleryTitle() {
      const galleryTitle = document.querySelector('.gallery-section h2');
      if (galleryTitle) galleryTitle.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function attachGalleryThumbnails() {
      const lightbox = document.getElementById('galleryLightbox');
      const galleryItems = document.querySelectorAll('#galleryGrid .gallery-thumbnail');
      galleryItems.forEach(item => {
        item.addEventListener('click', () => {
          currentImageIndex = Number(item.getAttribute('data-index'));
          updateLightbox(currentImageIndex);
          lightbox.classList.add('active');
          document.body.style.overflow = 'hidden';
        });
      });
    }
    
    function renderCategoryDetails(category, projects) {
      let html = `
        <a href="index.html" class="back-link inline-block bg-[#005f73] text-white py-3 px-6 rounded-lg font-semibold w-fit transition-colors duration-300 hover:bg-[#004c59] mx-auto my-4">
          <i class="fas fa-arrow-left"></i> Back to Projects
        </a>
        <section class="category-header text-center p-8">
          <h1 class="text-4xl font-bold">${category.categoryName}</h1>
          <p class="mt-4">${category.description}</p>
        </section>
      `;
      projects.forEach((project, projectIndex) => {
        const testimonials = project["feature-project-testimonial"] && Array.isArray(project["feature-project-testimonial"]) ? 
                             project["feature-project-testimonial"].filter(t => t["testimonial-quote"] && t["testimonial-quote"] !== null) : [];
        const hasTestimonials = testimonials.length > 0;
        const testimonialCount = testimonials.length;
        const testimonialSectionTitle = testimonialCount === 1 ? 'Testimonial' : 'Testimonials';

        const youtubeVideos = project["feature-project-youtube-link"] && Array.isArray(project["feature-project-youtube-link"]) ? 
                              project["feature-project-youtube-link"].filter(video => video.url && video.url !== null && video.url !== '') : [];
        const hasYouTubeVideos = youtubeVideos.length > 0;
        const videoCount = youtubeVideos.length;
        const youtubeSectionTitle = videoCount === 1 ? 'Video' : 'Videos';

        html += `
          <article class="project-detail max-w-[1100px] bg-white rounded-xl overflow-hidden shadow-lg mx-auto mb-8" data-project-index="${projectIndex}">
            <header class="detail-header bg-[var(--header-gradient)] text-center text-white flex flex-col pb-4 relative">
              <h2 class="project-title my-4 text-3xl font-bold tracking-wide shadow-[1px_1px_2px_rgba(0,0,0,0.3)]">${project["feature-project-name"]}</h2>
              ${project["feature-project-start-year"] ? `
                <div class="project-meta text-base opacity-90 flex justify-center gap-4 py-1">
                  <span>${project["feature-project-start-year"]}${project["feature-project-end-year"] ? ` - ${project["feature-project-end-year"]}` : ''}</span>
                </div>
              ` : ''}
            </header>
            <img src="${project["feature-project-thumbnail"]}" alt="${project["feature-project-name"]}" class="detail-image max-w-full block w-[600px] mx-auto my-4 h-[250px] object-contain transition-transform duration-400 hover:scale-103" loading="lazy">
            <section class="detail-content p-8">
              <p class="project-description max-w-[900px] mx-auto mb-8 text-lg text-justify text-gray-600">${project["feature-project-long-description"]}</p>
              ${hasTestimonials ? `
                <div class="testimonial-section my-8 relative">
                  <h2 class="text-center text-3xl mb-6 relative pb-2">${testimonialSectionTitle}</h2>
                  <div class="testimonial-container max-w-[900px] mx-auto overflow-hidden">
                    <div class="testimonial-slider flex transition-transform duration-500 w-full">
                      ${testimonials.map(testimonial => `
                        <div class="testimonial-item flex-shrink-0 w-full bg-white border border-gray-200 rounded-lg p-8 text-center shadow-md">
                          <p class="testimonial-quote text-lg italic text-gray-600 mb-4">"${testimonial["testimonial-quote"]}"</p>
                          <p class="testimonial-author font-semibold text-[#005f73] mb-2">${testimonial["testimonial-name"]}</p>
                          <p class="testimonial-role text-sm text-gray-800 opacity-80">${testimonial["testimonial-role"]}${testimonial["testimonial-client-name"] ? `, ${testimonial["testimonial-client-name"]}` : ''}</p>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                  ${testimonialCount > 1 ? `
                    <div class="testimonial-nav flex justify-center gap-4 mt-4">
                      <button class="testimonial-nav-btn prev bg-[#005f73] text-white border-none rounded-full w-10 h-10 flex items-center justify-center cursor-pointer transition-all duration-300 hover:bg-[#004c59] hover:scale-110 disabled:bg-gray-300 disabled:cursor-not-allowed" aria-label="Previous testimonial">
                        <i class="fas fa-chevron-left"></i>
                      </button>
                      <button class="testimonial-nav-btn next bg-[#005f73] text-white border-none rounded-full w-10 h-10 flex items-center justify-center cursor-pointer transition-all duration-300 hover:bg-[#004c59] hover:scale-110 disabled:bg-gray-300 disabled:cursor-not-allowed" aria-label="Next testimonial">
                        <i class="fas fa-chevron-right"></i>
                      </button>
                    </div>
                    <div class="testimonial-dots flex justify-center gap-2 mt-4">
                      ${testimonials.map((_, index) => `
                        <span class="testimonial-dot w-3 h-3 bg-gray-300 rounded-full cursor-pointer transition-colors duration-300 ${index === 0 ? 'active bg-[#005f73]' : ''}" data-index="${index}"></span>
                      `).join('')}
                    </div>
                  ` : ''}
                </div>
              ` : ''}
              ${hasYouTubeVideos ? `
                <div class="youtube-section my-8 relative">
                  <h2 class="text-center text-3xl mb-6 relative pb-2">${youtubeSectionTitle}</h2>
                  <div class="youtube-container max-w-[900px] mx-auto overflow-hidden">
                    <div class="youtube-slider flex transition-transform duration-500 w-full">
                      ${youtubeVideos
                        .sort((a, b) => a.order - b.order)
                        .map(video => `
                          <div class="youtube-item flex-shrink-0 w-full bg-white border border-gray-200 rounded-lg p-4 text-center shadow-md">
                            <iframe src="${video.url}" title="${video.title}" allowfullscreen loading="lazy" class="w-full aspect-video border-none mb-4 mx-auto"></iframe>
                            <p class="youtube-title text-lg font-semibold text-[#005f73] mb-2">${video.title}</p>
                            <p class="youtube-description text-base text-gray-600">${video.description}</p>
                          </div>
                        `).join('')}
                    </div>
                  </div>
                  ${videoCount > 1 ? `
                    <div class="youtube-nav flex justify-center gap-4 mt-4 mb-5">
                      <button class="youtube-nav-btn prev bg-[#005f73] text-white border-none rounded-full w-10 h-10 flex items-center justify-center cursor-pointer transition-all duration-300 hover:bg-[#004c59] hover:scale-110 disabled:bg-gray-300 disabled:cursor-not-allowed" aria-label="Previous video">
                        <i class="fas fa-chevron-left"></i>
                      </button>
                      <button class="youtube-nav-btn next bg-[#005f73] text-white border-none rounded-full w-10 h-10 flex items-center justify-center cursor-pointer transition-all duration-300 hover:bg-[#004c59] hover:scale-110 disabled:bg-gray-300 disabled:cursor-not-allowed" aria-label="Next video">
                        <i class="fas fa-chevron-right"></i>
                      </button>
                    </div>
                    <div class="youtube-dots flex justify-center gap-2 mt-4">
                      ${youtubeVideos.map((_, index) => `
                        <span class="youtube-dot w-3 h-3 bg-gray-300 rounded-full cursor-pointer transition-colors duration-300 ${index === 0 ? 'active bg-[#005f73]' : ''}" data-index="${index}"></span>
                      `).join('')}
                    </div>
                  ` : ''}
                </div>
              ` : ''}
              ${project["feature-project-gallery"] && project["feature-project-gallery"].length ? `
                <div class="gallery-section" data-project-id="${project.id}">
                  <h2 class="text-center text-3xl mb-6 relative pb-2">Gallery</h2>
                  <div class="gallery-grid grid grid-cols-[repeat(auto-fit,minmax(280px,1fr))] gap-6 max-w-[1100px] mx-auto">
                    ${project["feature-project-gallery"].sort((a, b) => a.order - b.order)
                      .map((image, i) => `
                        <div class="gallery-item relative border border-gray-200 rounded-lg overflow-hidden cursor-pointer bg-white transition-all duration-300 hover:-translate-y-1 hover:shadow-xl">
                          <img src="${image.image}" alt="${image['alt-text']}" class="gallery-thumbnail w-full aspect-video object-contain block" data-index="${i}" loading="lazy">
                          <div class="gallery-overlay absolute bottom-0 left-0 right-0 bg-[#005f73]/85 text-white p-2 text-center text-sm opacity-0 transition-opacity duration-300 hover:opacity-100">${image.description}</div>
                        </div>
                      `).join('')}
                  </div>
                </div>
              ` : ''}
            </section>
          </article>
        `;
      });
      detailsContainer.innerHTML = html + getLightboxMarkup();
      attachCategoryGalleryListeners(projects);

      projects.forEach((project, projectIndex) => {
        const projectContainer = detailsContainer.querySelector(`article.project-detail[data-project-index="${projectIndex}"]`);
        if (!projectContainer) return;

        const testimonials = project["feature-project-testimonial"] && Array.isArray(project["feature-project-testimonial"]) ? 
                             project["feature-project-testimonial"].filter(t => t["testimonial-quote"] && t["testimonial-quote"] !== null) : [];
        const hasTestimonials = testimonials.length > 0;
        const testimonialCount = testimonials.length;

        if (hasTestimonials && testimonialCount > 1) {
          const slider = projectContainer.querySelector('.testimonial-slider');
          const prevBtn = projectContainer.querySelector('.testimonial-nav-btn.prev');
          const nextBtn = projectContainer.querySelector('.testimonial-nav-btn.next');
          const dots = projectContainer.querySelectorAll('.testimonial-dot');
          initTestimonialSliderForProject(slider, prevBtn, nextBtn, dots, testimonialCount);
        }

        const youtubeVideos = project["feature-project-youtube-link"] && Array.isArray(project["feature-project-youtube-link"]) ? 
                              project["feature-project-youtube-link"].filter(video => video.url && video.url !== null && video.url !== '') : [];
        const hasYouTubeVideos = youtubeVideos.length > 0;
        const videoCount = youtubeVideos.length;

        if (hasYouTubeVideos && videoCount > 1) {
          const slider = projectContainer.querySelector('.youtube-slider');
          const prevBtn = projectContainer.querySelector('.youtube-nav-btn.prev');
          const nextBtn = projectContainer.querySelector('.youtube-nav-btn.next');
          const dots = projectContainer.querySelectorAll('.youtube-dot');
          initYouTubeSliderForProject(slider, prevBtn, nextBtn, dots, videoCount);
        }
      });
    }
    
    function getLightboxMarkup() {
      return `
        <div class="lightbox fixed inset-0 bg-[var(--lightbox-bg)] opacity-0 pointer-events-none transition-opacity duration-300 flex items-center justify-center p-4 z-[1000]" id="galleryLightbox">
          <div class="lightbox-content relative bg-black rounded-lg overflow-hidden w-[900px] flex flex-col">
            <button class="close-btn absolute top-2 right-2 bg-white/20 border-none rounded-full w-9 h-9 flex items-center justify-center cursor-pointer z-10 transition-all duration-300 hover:bg-white/30 hover:scale-110" aria-label="Close lightbox"></button>
            <div class="lightbox-image-container relative w-full text-center bg-black">
              <img class="lightbox-image max-w-full h-[500px] object-contain block mx-auto transition-opacity duration-300" src="" alt="">
              <div class="loading-spinner absolute w-10 h-10 border-4 border-white/30 rounded-full border-t-white animate-[spin_1s_ease-in-out_infinite] left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 hidden"></div>
              <button class="nav-btn prev-btn absolute top-1/2 -translate-y-1/2 bg-white/20 border-none rounded-full w-11 h-11 flex items-center justify-center cursor-pointer text-white text-xl transition-all duration-300 hover:bg-white/30 hover:scale-110 left-2" aria-label="Previous image"><i class="fas fa-chevron-left"></i></button>
              <button class="nav-btn next-btn absolute top-1/2 -translate-y-1/2 bg-white/20 border-none rounded-full w-11 h-11 flex items-center justify-center cursor-pointer text-white text-xl transition-all duration-300 hover:bg-white/30 hover:scale-110 right-2" aria-label="Next image"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="lightbox-caption bg-[#005f73] text-white p-4 text-center text-base"></div>
          </div>
        </div>
      `;
    }
    
    function attachCategoryGalleryListeners(projects) {
      const galleryThumbnails = document.querySelectorAll('.gallery-thumbnail');
      galleryThumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', (e) => {
          const gallerySection = e.target.closest('.gallery-section');
          const projectId = gallerySection.getAttribute('data-project-id');
          const project = projects.find(p => p.id === Number(projectId));
          if (!project) return;
          galleryImagesGlobal = (project["feature-project-gallery"] || []).sort((a, b) => a.order - b.order);
          currentImageIndex = Number(e.target.getAttribute('data-index'));
          updateLightbox(currentImageIndex);
          document.getElementById('galleryLightbox').classList.add('active');
          document.body.style.overflow = 'hidden';
        });
      });
    }
    
    function updateLightbox(index) {
      const lightbox = document.getElementById('galleryLightbox');
      const lightboxImage = lightbox.querySelector('.lightbox-image');
      const lightboxCaption = lightbox.querySelector('.lightbox-caption');
      const spinner = lightbox.querySelector('.loading-spinner');
      currentImageIndex = (index + galleryImagesGlobal.length) % galleryImagesGlobal.length;
      const image = galleryImagesGlobal[currentImageIndex];
      lightboxImage.style.opacity = '0';
      spinner.style.display = 'block';
      const img = new Image();
      img.src = image.image;
      img.onload = () => {
        spinner.style.display = 'none';
        lightboxImage.src = image.image;
        lightboxImage.alt = image['alt-text'];
        const imageCount = galleryImagesGlobal.length > 1 ? `Image ${currentImageIndex + 1} of ${galleryImagesGlobal.length} - ` : '';
        lightboxCaption.textContent = `${imageCount}${image.description}`;
        lightboxImage.style.opacity = '1';
      };
    }
    
    function nextImage() { updateLightbox(currentImageIndex + 1); }
    function prevImage() { updateLightbox(currentImageIndex - 1); }
    
    function initLightbox() {
      if (lightboxInitialized) return;
      const lightbox = document.getElementById('galleryLightbox');
      const closeBtn = lightbox.querySelector('.close-btn');
      const prevBtn = lightbox.querySelector('.prev-btn');
      const nextBtn = lightbox.querySelector('.next-btn');
      let touchStartX = 0;
      lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeModal(); });
      closeBtn.addEventListener('click', closeModal);
      prevBtn.addEventListener('click', prevImage);
      nextBtn.addEventListener('click', nextImage);
      document.addEventListener('keydown', (e) => {
        if (lightbox.classList.contains('active')) {
          if (e.key === 'ArrowLeft') prevImage();
          if (e.key === 'ArrowRight') nextImage();
          if (e.key === 'Escape') closeModal();
        }
      });
      lightbox.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; });
      lightbox.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].clientX;
        const deltaX = touchEndX - touchStartX;
        if (Math.abs(deltaX) > 50) deltaX > 0 ? prevImage() : nextImage();
      });
      lightboxInitialized = true;
    }
    
    function closeModal() {
      const lightbox = document.getElementById('galleryLightbox');
      lightbox.classList.remove('active');
      document.body.style.overflow = '';
    }
    
    function initTestimonialSlider(testimonialCount) {
      const slider = document.querySelector('.testimonial-slider');
      const prevBtn = document.querySelector('.testimonial-nav-btn.prev');
      const nextBtn = document.querySelector('.testimonial-nav-btn.next');
      const dots = document.querySelectorAll('.testimonial-dot');
      let currentIndex = 0;
      let touchStartX = 0;
      function updateSlider() {
        slider.style.transform = `translateX(-${currentIndex * 100}%)`;
        dots.forEach(dot => dot.classList.remove('active', 'bg-[#005f73]'));
        dots[currentIndex].classList.add('active', 'bg-[#005f73]');
        prevBtn.disabled = currentIndex === 0;
        nextBtn.disabled = currentIndex === testimonialCount - 1;
      }
      prevBtn.addEventListener('click', () => { if (currentIndex > 0) { currentIndex--; updateSlider(); } });
      nextBtn.addEventListener('click', () => { if (currentIndex < testimonialCount - 1) { currentIndex++; updateSlider(); } });
      dots.forEach(dot => {
        dot.addEventListener('click', () => { currentIndex = Number(dot.getAttribute('data-index')); updateSlider(); });
      });
      slider.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; });
      slider.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].clientX;
        const deltaX = touchEndX - touchStartX;
        if (Math.abs(deltaX) > 50) {
          if (deltaX > 0 && currentIndex > 0) currentIndex--;
          else if (deltaX < 0 && currentIndex < testimonialCount - 1) currentIndex++;
          updateSlider();
        }
      });
      updateSlider();
    }
    
    function initTestimonialSliderForProject(slider, prevBtn, nextBtn, dots, testimonialCount) {
      let currentIndex = 0;
      let touchStartX = 0;
      if (!slider || !prevBtn || !nextBtn || dots.length === 0) return;

      function updateSlider() {
        slider.style.transform = `translateX(-${currentIndex * 100}%)`;
        dots.forEach(dot => dot.classList.remove('active', 'bg-[#005f73]'));
        dots[currentIndex].classList.add('active', 'bg-[#005f73]');
        prevBtn.disabled = currentIndex === 0;
        nextBtn.disabled = currentIndex === testimonialCount - 1;
      }

      prevBtn.addEventListener('click', () => { if (currentIndex > 0) { currentIndex--; updateSlider(); } });
      nextBtn.addEventListener('click', () => { if (currentIndex < testimonialCount - 1) { currentIndex++; updateSlider(); } });
      dots.forEach(dot => {
        dot.addEventListener('click', () => { currentIndex = Number(dot.getAttribute('data-index')); updateSlider(); });
      });
      slider.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; });
      slider.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].clientX;
        const deltaX = touchEndX - touchStartX;
        if (Math.abs(deltaX) > 50) {
          if (deltaX > 0 && currentIndex > 0) currentIndex--;
          else if (deltaX < 0 && currentIndex < testimonialCount - 1) currentIndex++;
          updateSlider();
        }
      });
      updateSlider();
    }
    
    function initYouTubeSlider(videoCount) {
      const slider = document.querySelector('.youtube-slider');
      const prevBtn = document.querySelector('.youtube-nav-btn.prev');
      const nextBtn = document.querySelector('.youtube-nav-btn.next');
      const dots = document.querySelectorAll('.youtube-dot');
      let currentIndex = 0;
      let touchStartX = 0;
      
      if (!slider || !prevBtn || !nextBtn || !dots.length) return;
      
      function updateSlider() {
        slider.style.transform = `translateX(-${currentIndex * 100}%)`;
        dots.forEach(dot => dot.classList.remove('active', 'bg-[#005f73]'));
        dots[currentIndex].classList.add('active', 'bg-[#005f73]');
        prevBtn.disabled = currentIndex === 0;
        nextBtn.disabled = currentIndex === videoCount - 1;
      }
      
      prevBtn.addEventListener('click', () => { if (currentIndex > 0) { currentIndex--; updateSlider(); } });
      nextBtn.addEventListener('click', () => { if (currentIndex < videoCount - 1) { currentIndex++; updateSlider(); } });
      dots.forEach(dot => {
        dot.addEventListener('click', () => { currentIndex = Number(dot.getAttribute('data-index')); updateSlider(); });
      });
      slider.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; });
      slider.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].clientX;
        const deltaX = touchEndX - touchStartX;
        if (Math.abs(deltaX) > 50) {
          if (deltaX > 0 && currentIndex > 0) currentIndex--;
          else if (deltaX < 0 && currentIndex < videoCount - 1) currentIndex++;
          updateSlider();
        }
      });
      updateSlider();
    }
    
    function initYouTubeSliderForProject(slider, prevBtn, nextBtn, dots, videoCount) {
      let currentIndex = 0;
      let touchStartX = 0;
      if (!slider || !prevBtn || !nextBtn || dots.length === 0) return;

      function updateSlider() {
        slider.style.transform = `translateX(-${currentIndex * 100}%)`;
        dots.forEach(dot => dot.classList.remove('active', 'bg-[#005f73]'));
        dots[currentIndex].classList.add('active', 'bg-[#005f73]');
        prevBtn.disabled = currentIndex === 0;
        nextBtn.disabled = currentIndex === testimonialCount - 1;
      }

      prevBtn.addEventListener('click', () => { if (currentIndex > 0) { currentIndex--; updateSlider(); } });
      nextBtn.addEventListener('click', () => { if (currentIndex < videoCount - 1) { currentIndex++; updateSlider(); } });
      dots.forEach(dot => {
        dot.addEventListener('click', () => { currentIndex = Number(dot.getAttribute('data-index')); updateSlider(); });
      });
      slider.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; });
      slider.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].clientX;
        const deltaX = touchEndX - touchStartX;
        if (Math.abs(deltaX) > 50) {
          if (deltaX > 0 && currentIndex > 0) currentIndex--;
          else if (deltaX < 0 && currentIndex < videoCount - 1) currentIndex++;
          updateSlider();
        }
      });
      updateSlider();
    }
    
    function showDetailError() {
      detailsContainer.innerHTML = `
        <div class="error-state text-center p-8">
          <p class="text-xl">âš ï¸ Project or Category not found</p>
          <a href="index.html" class="back-link inline-block bg-[#005f73] text-white py-3 px-6 rounded-lg font-semibold w-fit transition-colors duration-300 hover:bg-[#004c59] mt-4">
            <i class="fas fa-arrow-left"></i> Return to Projects
          </a>
        </div>
      `;
    }
    
    function initBackToTop() {
      const backToTop = document.querySelector('.back-to-top');
      window.addEventListener('scroll', () => { backToTop.classList.toggle('visible', window.scrollY > 50); backToTop.classList.toggle('opacity-80', window.scrollY > 50); });
      backToTop.addEventListener('click', () => {
        backToTop.classList.remove('visible', 'opacity-80');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    }
    
    if (projectParam || categoryParam) {
      initPage().then(() => { initBackToTop(); });
    } else {
      window.location.href = 'index.html';
    }
  </script>
  
  <script src="sharable-scripts.js" defer></script>
</body>
</html>